import asyncio
from aiogram import Bot, Dispatcher, F
from aiogram.types import Message, CallbackQuery
from aiogram.fsm.context import FSMContext

from config import 8350573268:AAG3jFDklUBVHdz9gl2R5CeKRTJ68yl_JRI
from database import engine, Session
from models import Base, User
from states import RegisterState
from keyboards import language_kb
from mail import send_code

bot = Bot(8350573268:AAG3jFDklUBVHdz9gl2R5CeKRTJ68yl_JRI)
dp = Dispatcher()

TEMP_CODES = {}

@dp.message(F.text == "/start")
async def start(message: Message, state: FSMContext):
    async with Session() as session:
        user = await session.get(User, {"telegram_id": message.from_user.id})
        if user:
            await message.answer("‚úÖ –í—ã —É–∂–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω—ã")
            return

    await message.answer(
        "–í—ã–±–µ—Ä–∏—Ç–µ —è–∑—ã–∫ / Choose language",
        reply_markup=language_kb()
    )
    await state.set_state(RegisterState.language)

@dp.callback_query(RegisterState.language)
async def set_language(call: CallbackQuery, state: FSMContext):
    lang = "ru" if call.data == "lang_ru" else "en"
    await state.update_data(language=lang)

    text = "–í–≤–µ–¥–∏—Ç–µ –≤–∞—à—É –ø–æ—á—Ç—É:" if lang == "ru" else "Enter your email:"
    await call.message.answer(text)
    await state.set_state(RegisterState.email)

@dp.message(RegisterState.email)
async def set_email(message: Message, state: FSMContext):
    email = message.text.lower()
    code = send_code(email)

    TEMP_CODES[message.from_user.id] = code
    await state.update_data(email=email)

    await message.answer("üì© –í–≤–µ–¥–∏—Ç–µ –∫–æ–¥ –∏–∑ –ø–∏—Å—å–º–∞:")
    await state.set_state(RegisterState.code)

@dp.message(RegisterState.code)
async def check_code(message: Message, state: FSMContext):
    if TEMP_CODES.get(message.from_user.id) != message.text:
        await message.answer("‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π –∫–æ–¥")
        return

    data = await state.get_data()

    async with Session() as session:
        user = User(
            telegram_id=message.from_user.id,
            email=data["email"],
            email_verified=True,
            language=data["language"]
        )
        session.add(user)
        await session.commit()

    await message.answer("üéâ –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞")
    await state.clear()

async def main():
    async with engine.begin() as conn:
        await conn.run_sync(Base.metadata.create_all)

    await dp.start_polling(bot)

if name == "main":
    asyncio.run(main())